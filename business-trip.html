<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出差申请报告表 - Excel预览</title>
    <!-- 引入 SheetJS 在线库（无需下载，直接引用，与子页面1一致） -->
    <script src="xlsx.full.min.js"></script>
    <style>
        body { margin: 20px; font-family: "微软雅黑", sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .back-btn { padding: 8px 16px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; background: #f5f5f5; }
        .back-btn:hover { background: #eee; }
        h1 { color: #333; margin: 0; }
        /* 文件列表样式，与子页面1一致，便于统一维护拓展 */
        #fileList { border: 2px dashed #ccc; border-radius: 5px; padding: 20px; margin-bottom: 30px; }
        #fileList h2 { color: #555; margin-top: 0; margin-bottom: 20px; font-size: 18px; }
        .file-item { 
            display: flex; align-items: center; padding: 10px 15px; 
            border-bottom: 1px solid #eee; cursor: pointer;
        }
        .file-item:hover { background-color: #f5f5f5; }
        .file-name { flex: 1; color: #333; }
        .file-tip { color: #666; font-size: 14px; margin-left: 20px; }
        /* 预览区域样式，与子页面1一致 */
        #previewArea { border: 1px solid #eee; border-radius: 5px; padding: 20px; min-height: 300px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
        th { background-color: #f5f5f5; font-weight: bold; }
        tr:hover { background-color: #fafafa; }
        /* 无文件提示 */
        .no-file { text-align: center; color: #666; padding: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- 返回主页面按钮，跳转地址关联主页面文件名，与子页面1一致 -->
            <div class="back-btn" onclick="window.location.href='index.html'">返回主页面</div>
            <h1>出差申请报告表 - Excel在线预览</h1>
        </div>
        
        <!-- 文件列表区域：仅展示「出差申请报告表」子文件夹下所有Excel文件 -->
        <div id="fileList">
            <h2>「出差申请报告表」文件夹文件列表（点击预览，右键下载）</h2>
            <div id="fileItems">
                <p class="no-file">正在加载文件列表...若长时间无显示，请检查文件夹权限或IIS配置</p>
            </div>
        </div>

        <!-- 预览区域，用于显示解析后的Excel表格 -->
        <div id="previewArea">
            <p style="text-align: center; color: #666;">请点击上方文件列表中的Excel文件，进行在线预览</p>
        </div>
    </div>

    <!-- 核心JS代码：与子页面1一致，仅修改子文件夹路径，可复用 -->
    <script>
        // 获取页面元素
        const fileItems = document.getElementById('fileItems');
        const previewArea = document.getElementById('previewArea');
        // 子文件夹路径（严格对应「出差申请报告表」子文件夹名称，不可修改）
        const folderPath = '出差申请报告表';

        // 1. 加载子文件夹内所有Excel文件，生成文件列表（与子页面1逻辑一致）
        function loadFileList() {
            fetch(folderPath)
                .then(response => {
                    if (!response.ok) throw new Error('文件列表加载失败，请检查IIS目录浏览是否启用或子文件夹是否存在');
                    return response.text();
                })
				
				
 
			 const response =>{} 
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const links = doc.querySelectorAll('a[href$=".xlsx"], a[href$=".xls"]');
                    
                    if (links.length === 0) {
                        fileItems.innerHTML = '<p class="no-file">「出差申请报告表」文件夹内暂无.xlsx或.xls格式的Excel文件</p>';
                        return;
                    }

                    let fileListHtml = '';
                    links.forEach(link => {
                        const fileName = link.textContent.trim();
                        const fileUrl = `${folderPath}/${fileName}`; // 拼接子文件夹路径
                        fileListHtml += `<div class="file-item" data-fileurl="${fileUrl}" data-filename="${fileName}">
                                <div class="file-name">${fileName}</div>
                                <div class="file-tip">点击预览 | 右键下载</div>
                            </div>
                        `;
                    });

                    fileItems.innerHTML = fileListHtml;
                    bindFileEvents();
                })
                .catch(error => {
                    fileItems.innerHTML = `<p class="no-file" style="color: #ff0000;">${error.message}</p>`;
                    console.error('文件列表加载错误：', error);
                });
        }

        // 2. 绑定文件项的点击（预览）和右键（下载）事件（与子页面1一致）
        function bindFileEvents() {
            const items = document.querySelectorAll('.file-item');
            items.forEach(item => {
                item.addEventListener('click', function() {
                    const fileUrl = this.getAttribute('data-fileurl');
                    const fileName = this.getAttribute('data-filename');
                    previewExcel(fileUrl, fileName);
                });

                item.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    const fileUrl = this.getAttribute('data-fileurl');
                    const fileName = this.getAttribute('data-filename');
                    downloadExcel(fileUrl, fileName);
                });
            });
        }
				
        // 3. 预览Excel文件（与子页面1一致，核心解析逻辑不变）
        function previewExcel(fileUrl, fileName) {
            previewArea.innerHTML = `<p style="text-align: center; color: #666;">正在预览 ${fileName}...</p>`;
            
            fetch(fileUrl)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    try {
                        const wb = XLSX.read(new Uint8Array(buffer), { 
                            type: 'array', 
                            cellStyles: true, 
                            raw: false, 
                            codepage: 65001 
                        });
                        const sheetNames = wb.SheetNames;
                        let htmlContent = `<h3 style="color: #333;">当前预览文件：${fileName}</h3>`;

                        sheetNames.forEach(sheetName => {
                            const ws = wb.Sheets[sheetName];
                            const sheetHtml = XLSX.utils.sheet_to_html(ws, {
                                header: '<th></th>',
                                id: `sheet-${sheetName}`,
                                class: 'excel-sheet'
                            });
                            htmlContent += `<div style="margin-bottom: 30px;">
                                <h4 style="color: #666; margin: 15px 0;">工作表：${sheetName}</h4>
                                ${sheetHtml}
                            </div>`;
                        });

                        previewArea.innerHTML = htmlContent;
                    } catch (error) {
                        previewArea.innerHTML = `<p style="text-align: center; color: #ff0000;">文件 ${fileName} 解析失败，可能是文件损坏或格式不兼容</p>`;
                        console.error('Excel解析错误：', error);
                    }
                })
                .catch(error => {
                    previewArea.innerHTML = `<p style="text-align: center; color: #ff0000;">文件 ${fileName} 加载失败，请检查文件权限</p>`;
                    console.error('文件加载错误：', error);
                });
        }

        // 4. 下载Excel文件（与子页面1一致）
        function downloadExcel(fileUrl, fileName) {
            const a = document.createElement('a');
            a.href = fileUrl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // 页面加载完成后，自动加载文件列表
        window.onload = loadFileList;
    </script>
</body>
</html>